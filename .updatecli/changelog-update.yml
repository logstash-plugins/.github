---
name: Update Changelog in Logstash plugins
pipelineid: changelog-update

scms:
  default:
    kind: github
    spec:
      user: 'github-actions[bot]'
      username: 'github-actions[bot]'
      email: '41898282+github-actions[bot]@users.noreply.github.com'
      owner: '{{ requiredEnv "GITHUB_REPOSITORY_OWNER" }}'
      repository: '{{ requiredEnv "TARGET_REPOSITORY" }}'
      token: '{{ requiredEnv "GH_TOKEN" }}'
      branch: '{{ requiredEnv "TARGET_BRANCH" }}'
      workingBranch: false
      force: false
      commitMessage:
        squash: true
        type: "chore"
        title: >-
          {{ if eq (requiredEnv "VERSION_BUMP") "changelog:add" }}
          Append message to CHANGELOG.md
          {{ else }}
          Bump version and update CHANGELOG.md
          {{ end }}

sources:
  version:
    name: Calculate version based on VERSION_BUMP
    kind: shell
    scmid: default
    spec:
      command: |
        VERSION=$(cat version 2>/dev/null || grep -oE '[0-9]+\.[0-9]+\.[0-9]+' VERSION | head -1)
        VERSION_BUMP="{{ requiredEnv "VERSION_BUMP" }}"
        
        if [ "$VERSION_BUMP" = "changelog:add" ]; then
          echo "$VERSION"
          exit 0
        fi

        MAJOR=$(echo "$VERSION" | cut -d. -f1)
        MINOR=$(echo "$VERSION" | cut -d. -f2)
        PATCH=$(echo "$VERSION" | cut -d. -f3)
        
        case "$VERSION_BUMP" in
          changelog:major)
            echo "$((MAJOR + 1)).0.0"
            ;;
          changelog:minor)
            echo "$MAJOR.$((MINOR + 1)).0"
            ;;
          changelog:patch)
            echo "$MAJOR.$MINOR.$((PATCH + 1))"
            ;;
        esac

conditions:
  isNewVersion:
    name: Check if this is a new version (not append)
    kind: shell
    disablesourceinput: true
    spec:
      command: |
        test "{{ requiredEnv "VERSION_BUMP" }}" != "changelog:add"

  isAppend:
    name: Check if this is append mode
    kind: shell
    disablesourceinput: true
    spec:
      command: |
        test "{{ requiredEnv "VERSION_BUMP" }}" = "changelog:add"

targets:
  # Target for new version (major, minor, patch)
  updateChangelogNewVersion:
    name: Update CHANGELOG.md with new version entry
    kind: shell
    scmid: default
    disablesourceinput: true
    conditionids:
      - isNewVersion
    spec:
      command: |
        sed -i "1i## {{ source "version" }}\n  - {{ requiredEnv "PR_TITLE" }} [#{{ requiredEnv "PR_NUMBER" }}](https://github.com/{{ requiredEnv "GITHUB_REPOSITORY_OWNER" }}/{{ requiredEnv "TARGET_REPOSITORY" }}/pull/{{ requiredEnv "PR_NUMBER" }})\n" CHANGELOG.md
        echo "Changelog updated with new version {{ source "version" }}"
  
  # Target for append mode (add to existing version section)
  updateChangelogAppend:
    name: Append entry to current version in CHANGELOG.md
    kind: shell
    scmid: default
    disablesourceinput: true
    conditionids:
      - isAppend
    spec:
      command: |
        sed -i '2i\  - {{ requiredEnv "PR_TITLE" }} [#{{ requiredEnv "PR_NUMBER" }}](https://github.com/{{ requiredEnv "GITHUB_REPOSITORY_OWNER" }}/{{ requiredEnv "TARGET_REPOSITORY" }}/pull/{{ requiredEnv "PR_NUMBER" }})' CHANGELOG.md
        echo "message appended to Changelog"
